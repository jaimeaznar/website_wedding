{# app/templates/rsvp.html - BILINGUAL VERSION #}
{% extends "base.html" %}
{% block title %}RSVP{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="text-center mb-4">
                <h1>RSVP</h1>
                <p class="lead"><span data-translate="rsvp.welcome">Welcome</span>, {{ guest.name }}!</p>
                {% if rsvp and not rsvp.is_cancelled and rsvp.is_editable %}
                <p class="text-muted"><span data-translate="rsvp.last.updated">Last updated</span>: {{
                    rsvp.last_updated.strftime('%Y-%m-%d %H:%M') }}</p>
                {% endif %}
            </div>

            {% if show_warning %}
            <div class="alert alert-warning mb-4">
                <h4 class="alert-heading" data-translate="alert.changes.restricted">Changes Restricted</h4>
                <p><span data-translate="alert.changes.not.possible">Changes are not possible within</span> {{ config.WARNING_CUTOFF_DAYS }} <span data-translate="alert.days.of.wedding">days of the wedding date.</span></p>
                <hr>
                <p class="mb-0"><span data-translate="alert.need.assistance">Need assistance? Contact us at:</span> {{ admin_phone }}</p>
            </div>
            {% endif %}

            {% if rsvp and rsvp.is_cancelled %}
            <div class="alert alert-info mb-4">
                <h4 class="alert-heading" data-translate="rsvp.cancelled">RSVP Cancelled</h4>
                <p><span data-translate="rsvp.cancelled.message">Your RSVP was cancelled on</span> {{
                    rsvp.cancellation_date.strftime('%Y-%m-%d %H:%M') }}</p>
            </div>
            {% endif %}

            <form method="POST" action="{{ url_for('rsvp.edit_rsvp', token=guest.token) }}" id="rsvpForm" {% if readonly %}class="form-readonly" {% endif %}>
                {{ form.csrf_token }}

                <!-- Attendance Section -->
                <div class="form-section">
                    <div class="form-section-header">
                        <h3 class="mb-0" data-translate="rsvp.will.attend">Will you attend?</h3>
                    </div>
                    <div class="form-section-body">
                        <div class="attendance-options">
                            <div class="attendance-option">
                                <input type="radio" name="is_attending"
                                    value="yes" id="is_attending_0" required {%
                                    if rsvp and rsvp.is_attending %}checked{%
                                    endif %}>
                                <label for="is_attending_0">
                                    <i class="fas fa-check-circle"></i>
                                    <span data-translate="rsvp.yes">Yes, I will attend</span>
                                </label>
                            </div>
                            <div class="attendance-option">
                                <input type="radio" name="is_attending"
                                    value="no" id="is_attending_1" required {%
                                    if rsvp and not rsvp.is_attending and not
                                    rsvp.is_cancelled %}checked{% endif %}>
                                <label for="is_attending_1">
                                    <i class="fas fa-times-circle"></i>
                                    <span data-translate="rsvp.no">No, I cannot attend</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Details Section -->
                <div id="attendance_details" class="attendance-section" {% if
                    not rsvp or not rsvp.is_attending %}style="display: none;"
                    {% endif %}>
                    <!-- Hotel Information -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3 class="mb-0" data-translate="rsvp.accommodation.title">Accommodation</h3>
                        </div>
                        <div class="form-section-body">
                            <div class="mb-3">
                                <label class="form-label" for="hotel_name" data-translate="rsvp.where.staying">Where are you staying?</label>
                                <input type="text" class="form-control" name="hotel_name" id="hotel_name"
                                    value="{{ rsvp.hotel_name if rsvp and rsvp.hotel_name else '' }}"
                                    data-translate-placeholder="rsvp.hotel.placeholder"
                                    placeholder="Enter hotel name or leave blank if undecided">
                                <div class="form-text" data-translate="rsvp.hotel.help">Please let us know where you'll be staying.</div>
                                {% if form.hotel_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.hotel_name.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Transport Options -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3 class="mb-0" data-translate="rsvp.transport.title">Transportation</h3>
                        </div>
                        <div class="form-section-body">
                            <p data-translate="rsvp.transport.question">Would you like us to arrange transportation?</p>
                            <div class="form-check mb-2">
                                <input class="form-check-input transport-checkbox" type="checkbox"
                                    name="transport_to_reception" id="transport_to_reception"
                                    {% if rsvp and rsvp.transport_to_reception %}checked{% endif %}>
                                <label class="form-check-label" for="transport_to_reception" data-translate="rsvp.transport.reception">Transport to reception</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input transport-checkbox" type="checkbox"
                                    name="transport_to_hotel" id="transport_to_hotel"
                                    {% if rsvp and rsvp.transport_to_hotel %}checked{% endif %}>
                                <label class="form-check-label" for="transport_to_hotel" data-translate="rsvp.transport.hotel">Transport to hotel</label>
                            </div>
                        </div>
                    </div>

                    <!-- Dietary Restrictions - Main Guest -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3 class="mb-0"><span data-translate="rsvp.dietary.title">Dietary Restrictions</span> - {{ guest.name }}</h3>
                        </div>
                        <div class="form-section-body">
                            {% for allergen in allergens %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox"
                                    name="allergens_main"
                                    value="{{ allergen.id }}"
                                    id="allergen_main_{{ allergen.id }}" {% if
                                    readonly %}disabled{% endif %} {% if rsvp
                                    and allergen.id in rsvp.allergen_ids
                                    %}checked{% endif %}>
                                <label class="form-check-label"
                                    for="allergen_main_{{ allergen.id }}"
                                    data-translate="allergen.{{ allergen.name|lower|replace(' (tree nuts)', '')|replace(' ', '') }}"
                                    data-allergen-fallback="{{ allergen.name }}">
                                    {{ allergen.name }}
                                </label>
                            </div>
                            {% endfor %}
                            <div class="mt-3">
                                <label class="form-label" data-translate="rsvp.dietary.other">Other Dietary Restrictions</label>
                                <input type="text" class="form-control"
                                    name="custom_allergen_main"
                                    value="{{ rsvp.custom_allergen if rsvp else '' }}"
                                    {% if readonly %}readonly{% endif %}
                                    data-translate-placeholder="rsvp.dietary.placeholder"
                                    placeholder="Please specify any other dietary restrictions">
                            </div>
                        </div>
                    </div>

                    <!-- Family Guests Section -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h3 class="mb-0" data-translate="rsvp.family.title">Family Members</h3>
                        </div>
                        <div class="form-section-body">
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="adults_count" data-translate="rsvp.additional.adults">Number of Additional Adults</label>
                                    <select class="form-select" name="adults_count" id="adults_count">
                                        {% for i in range(11) %}
                                        <option value="{{ i }}" {% if rsvp and rsvp.adults_count == i %}selected{% endif %}>{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="children_count" data-translate="rsvp.children.count">Number of Children</label>
                                    <select class="form-select" name="children_count" id="children_count">
                                        {% for i in range(11) %}
                                        <option value="{{ i }}" {% if rsvp and rsvp.children_count == i %}selected{% endif %}>{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div id="additional_adults_container"></div>
                            <div id="children_container"></div>
                        </div>
                    </div>
                </div>

                <div class="form-actions text-center mt-4">
                    {% if not readonly %}
                        {% if is_editing %}
                        <button type="submit" class="btn btn-primary btn-lg" data-translate="rsvp.update">Update RSVP</button>
                        {% else %}
                        <button type="submit" class="btn btn-primary btn-lg" data-translate="rsvp.submit">Submit RSVP</button>
                        {% endif %}
                    {% endif %}

                    {% if rsvp and not rsvp.is_cancelled and rsvp.is_editable %}
                    <a href="{{ url_for('rsvp.cancel_rsvp', token=guest.token) }}"
                        class="btn btn-outline-danger btn-lg ms-2" data-translate="rsvp.cancel">
                        Cancel RSVP
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Personal Message Modal -->
{% if personal_message %}
<div class="modal fade" id="personalMessageModal" tabindex="-1" aria-labelledby="personalMessageModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center px-4 pb-4">
                <div class="mb-4">
                    <i class="fas fa-heart text-danger" style="font-size: 3rem;"></i>
                </div>
                <div class="personal-message mb-4">
                    {{ personal_message | safe }}
                </div>
                <button type="button" class="btn btn-primary btn-lg" data-bs-dismiss="modal">
                    <span data-translate="modal.personal.continue">Continue to RSVP â†’</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Show personal message modal on page load
    document.addEventListener('DOMContentLoaded', function() {
        var modal = new bootstrap.Modal(document.getElementById('personalMessageModal'));
        modal.show();
    });
</script>
{% endif %}

<!-- Template for allergen sections -->
<template id="allergen-template">
    {% for allergen in allergens %}
    <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox"
            name="allergens_PLACEHOLDER" value="{{ allergen.id }}"
            id="allergen_PLACEHOLDER_{{ allergen.id }}">
        <label class="form-check-label"
            for="allergen_PLACEHOLDER_{{ allergen.id }}"
            data-translate="allergen.{{ allergen.name|lower|replace(' ', '')|replace('(treenuts)', 'nuts')|replace('(', '')|replace(')', '') }}"
            data-allergen-fallback="{{ allergen.name }}">
            {{ allergen.name }}
        </label>
    </div>
    {% endfor %}
    <div class="mt-3">
        <label class="form-label" data-translate="rsvp.dietary.other">Other Dietary Restrictions</label>
        <input type="text" class="form-control"
            name="custom_allergen_PLACEHOLDER"
            data-translate-placeholder="rsvp.dietary.placeholder"
            placeholder="Please specify any other dietary restrictions">
    </div>
</template>

<!-- Hidden data elements to store allergen information for JavaScript -->
{% if rsvp and rsvp.allergens %}
{% for allergen in rsvp.allergens %}
<div class="d-none" data-allergen-guest="{{ allergen.guest_name }}"
    data-allergen-id="{{ allergen.allergen_id if allergen.allergen_id else 'None' }}"
    data-custom-allergen="{{ allergen.custom_allergen if allergen.custom_allergen else 'None' }}">
</div>
{% endfor %}
{% endif %}
<!-- Hidden data for existing additional guests -->
{% if rsvp and rsvp.additional_guests %}
<script id="existing-guests-data" type="application/json">
[
{% for guest in rsvp.additional_guests %}
    {"name": "{{ guest.name }}", "is_child": {{ 'true' if guest.is_child else 'false' }}}{% if not loop.last %},{% endif %}
{% endfor %}
]
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/rsvp.js') }}"></script>
{% endblock %}